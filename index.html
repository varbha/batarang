
<!doctype html>
<html>
  <head>

    <title>Edit | Collaborative Editor</title>
    <meta charset="utf-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript">
      //<![CDATA[
          $(window).on('load', function() { // makes sure the whole site is loaded
              $('#status').fadeOut(); // will first fade out the loading animation
              $('#preloader').delay(350).fadeOut('slow'); // will fade out the white DIV that covers the website.
              $('body').delay(350).css({'overflow':'visible'});
          })
      //]]>
  </script>
    <style>
    .navbar {
		margin-bottom: 0;
		background-color: #b30000;
    background-image: url('/material-wallpaper-8.jpg');
		z-index: 9999;
    border: 0;
		font-size: 12px !important;
		line-height: 1.2 !important;
		letter-spacing: 3px;
		border-radius: 0;
    }

   .navbar li a, .navbar .navbar-brand {
		color: #fff !important;
	}

	.navbar-brand {

	font-family: arial;
	letter-spacing: 1px;
	color: #b30000;

	}
	.navbar-nav li a:hover, .navbar-nav li.active a {
		color:  #000033; !important;
		background-color: #000 !important;
	}

	.navbar-default .navbar-toggle {
		border-color: transparent;
		color: #fff !important;

	}
  #preloader {
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
      background-color:#141414; /* change if the mask should have another color then white */
    z-index:99; /* makes sure it stays on top */
}

#status {
    width:700px;
    height:700px;
    position:absolute;
    left:50%; /* centers the loading animation horizontally one the screen */
    top:50%; /* centers the loading animation vertically one the screen */
    background-image:url('/status2.gif'); /* path to your loading animation */
    background-repeat:no-repeat;
    background-position:center;
    margin:-350px 0 0 -350px; /* is width and height divided by two */
}


      html, body {
          height: 100%;
          width: 100%;
          background-color:#000033;
          background: url("/material-wallpaper-8.jpg") no-repeat center;
          background-size:cover;
          background-attachment: fixed;

          font-family: arial;
      }


      #editor-wrapper{
          width: 100%;
          margin-left:auto;
          margin-right:auto;
          margin-top:3em;



      }
      #modeinput {
         width: 100%;
         margin-left:auto;
         margin-right:auto;
       }


      #username, #modeinfo {
          color: #f3f3f3;
      }

      .ouser, .roomno {
          color: #fff;
      }
      .cuser, .room, .modlang {
          color: #999;
      }
      #footer {
      color: #000000;
      }
	  textarea, iframe {
    			border: 2px solid #ddd;
    			height: 500px;
    			width: 100%;	
				color:#000000;
				background-color:white;
			}
    </style>
  </head>
  <body>
    <div id="preloader">
    <div id="status">&nbsp;</div>
</div>

    <!--navbar section-->
    <nav class="navs navbar navbar-default  navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="glyphicon glyphicon-sort-by-attributes-alt"></span>


            </button>
            <a class="navbar-brand navbar-left"><span class="glyphicon glyphicon-indent-left"></span>{ Rethink_Collaborator }</a>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
              <ul class="nav navbar-nav navbar-left">
                <li><a href="/">route.about</a></li>
                <li><a href="/next">route.profile</a></li>
                <li><a href="/rooms">route.rooms</a></li>
              </ul>
              <button class="btn btn-sm navbar-right btn-danger navbar-btn"><span class="glyphicon glyphicon-off"></span>&nbsp;&nbsp;log_out</button>
            </div>
          </div>
        </nav>
        <!--navbar ends-->
        <br>
        <br>


        <div class="container bg-grey" style="color:#ffffff;" >
        <div class="row ">
        <div class="col-sm-12" id="editor-wrapper">
        <span class="cuser">Current User: </span><span id="username"></span>
        <span class="room">Room: </span><span id="roomno"></span>
        <span class="modlang">Language:</span><span id="modeinfo"></span><br>

        <textarea id="editor"></textarea>
      </div>
    </div>
    <br>

    <div class="container" style="opcaity:0" id=modeinput>
      <div class="row">
        <div class="col-sm-6">
      <h3>Mode-Language control:</h3>
      <p>Use this to toggle between languages by setting the editor mode.</p>
      <form>
        <div class="form-group">
          <label for="mode">Select list (select one):</label>
          <select class="form-control"  id=mode>
            <option>choose.py</option>
            <option>choose.js</option>
            <option>choose.java</option>
            <option>choose.html</option>
            <option>choose.css</option>
            <option>choose.c</option>
            <option>choose.cpp</option>
          </select>
        </div>
    </form>
    <span><button class="btn btn-sm btn-success" style="color:#ffffff" type=button onclick="change()">change mode</button> </span>
    <br>
    </div>
    <div class="text-center col-sm-6" style="background-opacity:0">
      <h3><span class="glyphicon glyphicon-info-sign"></span> FAQ's</h3>
      <p>Lorem ipsum dilor sur amet Lorem ipsum dilor sor amet <br>
        Lorem ipsum dilor sur amet Lorem ipsum dilor sor amet <br>
        Lorem ipsum dilor sur amet Lorem ipsum dilor sor amet <br>
        Lorem ipsum dilor sur amet Lorem ipsum dilor sor amet <br>
        Lorem ipsum dilor sur amet Lorem ipsum dilor sor amet <br>
      </p>
    </div>
  </div>
  <div class="row" id="only-html" style="display:none">
  <table width="100%" border="0" cellspacing="5" cellpadding="5">
            <tr>
                <td width="50%" scope="col">&nbsp;</td>
                <td width="50%" align="left" scope="col">
                    <input onclick="runCode();" type="button" value="Run Code">
                </td>
            </tr>
            <tr>
                <td> 
                    <form>
                        <strong>Code</strong>
                        <textarea name="sourceCode" id="sourceCode">
<html>
<head>
<title>Hello</title>
</head>
<body>
<h1>Hello!</h1>
<p>Write HTML, CSS or JavaScript code here and click 'Run Code'.</p>
</body>
</html>
                        </textarea>
                    </form>
                </td>
                <td><strong>Output</strong><iframe name="targetCode" id="targetCode"></iframe></td>
            </tr>
        </table>  
</div>


  <footer style="color:#ffffff" class="foot bg-grey container-fluid text-center">
    <p> Made by Varun Bhatia &lt;&lt;Final Year Project&gt;&gt;<br>
      <span  class="glyphicon glyphicon-indent-left"></span>Rethink Collaborator

    </p>
  </footer>

    <script src="/bower_components/codemirror/lib/codemirror.js"></script>
    <link rel="stylesheet" href="/bower_components/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="/bower_components/codemirror/addon/display/fullscreen.css">
    <link rel="stylesheet" href="/bower_components/codemirror/theme/paraiso-dark.css">
    <script src="/bower_components/codemirror/addon/mode/loadmode.js"></script>
    <script src="/bower_components/codemirror/mode/meta.js"></script>
    <script src="/bower_components/codemirror/addon/display/fullscreen.js"></script>


    <script src="/socket.io/socket.io.js"></script>
    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script>
	
	function runCode()
            {
                var content = document.getElementById('sourceCode').value;
                var iframe = document.getElementById('targetCode');
                iframe = (iframe.contentWindow) ? iframe.contentWindow : (iframe.contentDocument.document) ? iframe.contentDocument.document : iframe.contentDocument;
                iframe.document.open();
                iframe.document.write(content);
                iframe.document.close();
                return false;
            }
            runCode();
			

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        var room = getParameterByName('room');
        var user = getParameterByName('user');

        document.getElementById("username").innerHTML = user;
        document.getElementById("roomno").innerHTML =room;


        CodeMirror.modeURL = "/bower_components/codemirror/mode/%N/%N.js";


        var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("editor"), {
            lineNumbers: true,
            theme: "paraiso-dark",
            extraKeys: {
        "F11": function(cm) {
          cm.setOption("fullScreen", !cm.getOption("fullScreen"));
        },
        "Esc": function(cm) {
          if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
        }
      }
        });
        var modeInput = document.getElementById("mode");
        CodeMirror.on(modeInput, "keypress", function(e) {
          if (e.keyCode == 13) change();
        });


        function change() {
          var val = modeInput.value, m, mode, spec;
          if (m = /.+\.([^.]+)$/.exec(val)) {
            var info = CodeMirror.findModeByExtension(m[1]);
            if (info) {
              mode = info.mode;
              spec = info.mime;
            }
          } else if (/\//.test(val)) {
            var info = CodeMirror.findModeByMIME(val);
            if (info) {
              mode = info.mode;
              spec = val;
            }
          } else {
            mode = spec = val;
          }
          if (mode) {

            myCodeMirror.setOption("mode", spec);
            CodeMirror.autoLoadMode(myCodeMirror, mode);
            document.getElementById("modeinfo").textContent = spec;
			if(mode=='htmlmixed'){
			alert("The tryit editor has been added to the page");
			document.getElementById("only-html").style.display="block";
			
			}
          } else {
            alert("Could not find a mode corresponding to " + val);
          }
        }
        console.log("length"+myCodeMirror.getValue.length);
        if(myCodeMirror.getValue().length==0)
        {
        myCodeMirror.getDoc()
        .setValue
("#Welcome to Rethink Collaborator.\n#Here, you can edit and store your code within this room.\n#All changes will be stored and updated in real-time!\n#Press F11 to enter full screen mode, ESC to exit.\n#Change the language of this code by using the field below the editor.");
        console.log(myCodeMirror.getValue.length);
        }



        var socket = io();

        $.ajax({
            url: '/getData/' + room,
            success: function(result, status, xhr) {
                myCodeMirror.setValue(result.value);
                console.log(result);
            }
        });

        myCodeMirror.on('keyup', function () {
            var msg = {
                id: room,
                user: user,
                value: myCodeMirror.getValue()
            }
            socket.emit('document-update',msg);
        });

        socket.on('doc', function(msg){
            if(msg.new_val.id === room && msg.new_val.user != user) {
                var current_pos = myCodeMirror.getCursor();
                myCodeMirror.getDoc().setValue(msg.new_val.value);
                myCodeMirror.setCursor(current_pos);
            }
        });

    </script>
  </body>
</html>
